<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Tutorial.Chapter03.Exercise02</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span> </span><a href="Grin.Exp.html"><span class="hs-identifier">Grin.Exp</span></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><a href="Grin.TypeEnv.html"><span class="hs-identifier">Grin.TypeEnv</span></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Functor.Foldable</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Lens.Micro</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">^.</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><a href="Grin.Interpreter.Abstract.Base.html"><span class="hs-identifier">Grin.Interpreter.Abstract.Base</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="Grin.Interpreter.Abstract.Base.html#TypeEnv"><span class="hs-identifier hs-type">TypeEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><a href="Grin.Interpreter.Abstract.TypeInference.html"><span class="hs-identifier">Grin.Interpreter.Abstract.TypeInference</span></a><span> </span><span class="hs-special">(</span><a href="Grin.Interpreter.Abstract.TypeInference.html#typeOfValue"><span class="hs-identifier hs-var">typeOfValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-comment">{-
Sparse case optimisation is a very powerful optimisation, which removes the
unnecessary case alternatives.

Exercise:
Read the Chapter 4.3.6
https://nbviewer.jupyter.org/github/grin-compiler/grin/blob/master/papers/boquist.pdf#page=143
-}</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-comment">-- | Sparse case optimisation uses ana to transform the program from top to down.</span><span>
</span><a name="line-25"></a><span class="hs-comment">-- It checks if the given alterntive can be removed. The alternative can be removed</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- if it does not match any of the Nodes in the type associated with the variable.</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- Literal matching alternatives must be kept.</span><span>
</span><a name="line-28"></a><span class="hs-identifier">sparseCaseOptimisation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Grin.TypeEnv.html#TypeEnv"><span class="hs-identifier hs-type">TypeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Grin.Exp.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Grin.Exp.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span>
</span><a name="line-29"></a><a name="sparseCaseOptimisation"><a href="Tutorial.Chapter03.Exercise02.html#sparseCaseOptimisation"><span class="hs-identifier">sparseCaseOptimisation</span></a></a><span> </span><a name="local-6989586621679285800"><a href="#local-6989586621679285800"><span class="hs-identifier">te</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ana</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-30"></a><span>  </span><a href="Grin.Exp.html#ECase"><span class="hs-identifier hs-var">ECase</span></a><span> </span><a name="local-6989586621679285801"><a href="#local-6989586621679285801"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679285802"><a href="#local-6989586621679285802"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679285803"><a href="#local-6989586621679285803"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679285800"><span class="hs-identifier hs-var">te</span></a><span> </span><span class="hs-operator hs-var">^.</span><span> </span><a href="Grin.TypeEnv.html#variable"><span class="hs-identifier hs-var">variable</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">Map.!</span><span> </span><a href="#local-6989586621679285801"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Grin.Exp.html#ECaseF"><span class="hs-identifier hs-var">ECaseF</span></a><span> </span><a href="#local-6989586621679285801"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-33"></a><span>        </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Grin.Exp.html#Alt"><span class="hs-identifier hs-var">Alt</span></a><span> </span><a name="local-6989586621679285804"><a href="#local-6989586621679285804"><span class="hs-identifier">cpat</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Tutorial.Chapter03.Exercise02.html#matchingAlt"><span class="hs-identifier hs-var">matchingAlt</span></a><span> </span><a href="#local-6989586621679285803"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621679285804"><span class="hs-identifier hs-var">cpat</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Tutorial.Chapter03.Exercise02.html#removeTheRedundantDefault"><span class="hs-identifier hs-var">removeTheRedundantDefault</span></a><span> </span><a href="#local-6989586621679285803"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621679285802"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-comment">-- Exercise: Use the function from the Data.Functor.Foldable library</span><span>
</span><a name="line-35"></a><span>  </span><a name="local-6989586621679285805"><a href="#local-6989586621679285805"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">undefined</span><span> </span><a href="#local-6989586621679285805"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- | Returns True if the given pattern can be matched with the type of the scrutinee</span><span>
</span><a name="line-39"></a><span class="hs-identifier">matchingAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Grin.TypeEnv.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Grin.Exp.html#CPat"><span class="hs-identifier hs-type">CPat</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-40"></a><a name="matchingAlt"><a href="Tutorial.Chapter03.Exercise02.html#matchingAlt"><span class="hs-identifier">matchingAlt</span></a></a><span> </span><span class="hs-identifier">_</span><span>                 </span><a href="Grin.Exp.html#DefaultPat"><span class="hs-identifier hs-var">DefaultPat</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-41"></a><span class="hs-identifier">matchingAlt</span><span> </span><span class="hs-special">(</span><a href="Grin.TypeEnv.html#T_SimpleType"><span class="hs-identifier hs-var">T_SimpleType</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="Grin.Exp.html#NodePat"><span class="hs-identifier hs-var">NodePat</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-42"></a><span class="hs-identifier">matchingAlt</span><span> </span><span class="hs-special">(</span><a href="Grin.TypeEnv.html#T_NodeSet"><span class="hs-identifier hs-var">T_NodeSet</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="Grin.Exp.html#LitPat"><span class="hs-identifier hs-var">LitPat</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- Exercise: The type of the literal should match the simple type</span><span>
</span><a name="line-44"></a><span class="hs-identifier">matchingAlt</span><span> </span><span class="hs-special">(</span><a href="Grin.TypeEnv.html#T_SimpleType"><span class="hs-identifier hs-var">T_SimpleType</span></a><span> </span><a name="local-6989586621679285806"><a href="#local-6989586621679285806"><span class="hs-identifier">st</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Grin.Exp.html#LitPat"><span class="hs-identifier hs-var">LitPat</span></a><span> </span><a name="local-6989586621679285807"><a href="#local-6989586621679285807"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- Exercise: The tag from the pattern should be present in the NodeSet.</span><span>
</span><a name="line-46"></a><span class="hs-identifier">matchingAlt</span><span> </span><span class="hs-special">(</span><a href="Grin.TypeEnv.html#T_NodeSet"><span class="hs-identifier hs-var">T_NodeSet</span></a><span> </span><a name="local-6989586621679285808"><a href="#local-6989586621679285808"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="Grin.Exp.html#NodePat"><span class="hs-identifier hs-var">NodePat</span></a><span> </span><a name="local-6989586621679285809"><a href="#local-6989586621679285809"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679285810"><a href="#local-6989586621679285810"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">-- | Remove the redundant detault</span><span>
</span><a name="line-49"></a><span class="hs-identifier">removeTheRedundantDefault</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Grin.TypeEnv.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Grin.Exp.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Grin.Exp.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">]</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- As we erase the actual value of the primitive, we can not be sure, of the</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- Default pattern is redunant, thus it must be kept.</span><span>
</span><a name="line-52"></a><a name="removeTheRedundantDefault"><a href="Tutorial.Chapter03.Exercise02.html#removeTheRedundantDefault"><span class="hs-identifier">removeTheRedundantDefault</span></a></a><span> </span><span class="hs-special">(</span><a href="Grin.TypeEnv.html#T_SimpleType"><span class="hs-identifier hs-var">T_SimpleType</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679285811"><a href="#local-6989586621679285811"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679285811"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- Exercise: If every element from the nodeset is covered by the alts</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- and there is a DefaultPat, it can be removed as it redundant</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- at it will never be accessed.</span><span>
</span><a name="line-57"></a><span class="hs-identifier">removeTheRedundantDefault</span><span> </span><span class="hs-special">(</span><a href="Grin.TypeEnv.html#T_NodeSet"><span class="hs-identifier hs-var">T_NodeSet</span></a><span> </span><a name="local-6989586621679285812"><a href="#local-6989586621679285812"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679285813"><a href="#local-6989586621679285813"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-58"></a></pre></body></html>